pipeline {
    agent any

    environment {
        // Maven e Java
        MAVEN_HOME = '/usr/share/maven'
        JAVA_HOME  = '/usr/lib/jvm/java-17-openjdk-amd64'

        // Git
        GIT_REPO_URL   = 'https://github.com/tiagomiguel55/lms-library.git'
        GIT_BRANCH    = 'main'
        CREDENTIALS_ID = 'password_for_github_tiago'

        // Docker Registry
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_REGISTRY_CREDENTIALS = 'dockerhub-credentials'
        DOCKER_REGISTRY_NAMESPACE = 'tiagomiguel55'

        // Docker
        IMAGE_NAME = 'lmsreadersquery'
        IMAGE_TAG  = "${GIT_COMMIT}"
        FULL_IMAGE_NAME = "${DOCKER_REGISTRY}/${DOCKER_REGISTRY_NAMESPACE}/${IMAGE_NAME}"

        // Swarm stacks
        STACK_NAME_DEV     = 'lmsreadersquery-dev'
        STACK_NAME_STAGING = 'lmsreadersquery-staging'
        STACK_NAME_PROD    = 'lmsreadersquery-prod'

        // Email
        EMAIL_RECIPIENT = 'migueltiago255@gmail.com'

        // Working directory
        WORK_DIR = 'P2/lms_readers_query'
    }

    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'staging', 'prod'],
            description: 'Deployment environment'
        )
        booleanParam(
            name: 'SKIP_DEPLOY',
            defaultValue: false,
            description: 'Skip deployment'
        )
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: "${GIT_BRANCH}",
                    url: "${GIT_REPO_URL}",
                    credentialsId: "${CREDENTIALS_ID}"
            }
        }

        stage('Compile') {
            when {
                expression { params.ENVIRONMENT != 'prod' }
            }
            steps {
                dir("${WORK_DIR}") {
                    sh """
                        ${MAVEN_HOME}/bin/mvn clean compile test-compile
                    """
                }
            }
        }

      /*  stage('CDC Tests') {
            when {
                expression { params.ENVIRONMENT == 'staging' }
            }
            steps {
                dir("${WORK_DIR}") {
                    sh """
                        docker build -f DockerfileUnitTests -t ${IMAGE_NAME}-tests:cdc .
                        docker run --rm -e TEST_TYPE=CDCTests ${IMAGE_NAME}-tests:cdc
                    """
                }
            }
            post {
                success {
                    echo "✅ CDC Tests passed!"
                }
                failure {
                    echo "❌ CDC Tests failed!"
                }
            }
        } */

        stage('Build & Package') {
            when {
                expression { params.ENVIRONMENT != 'prod' }
            }
            steps {
                dir("${WORK_DIR}") {
                    sh """
                        ${MAVEN_HOME}/bin/mvn package -DskipTests
                    """
                }
            }
        }

        stage('Build Docker Image') {
            when {
                expression { params.ENVIRONMENT != 'prod' }
            }
            steps {
                dir("${WORK_DIR}") {
                    sh """
                        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                        docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:${params.ENVIRONMENT}
                    """
                }
            }
        }

        stage('Push Docker Image to Registry') {
            when {
                expression { params.ENVIRONMENT == 'dev' || params.ENVIRONMENT == 'staging' }
            }
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: "${DOCKER_REGISTRY_CREDENTIALS}", usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                        sh """
                            echo "=========================================="
                            echo "Pushing image to registry..."
                            echo "Environment: ${params.ENVIRONMENT}"
                            echo "Registry: ${DOCKER_REGISTRY}"
                            echo "Namespace: ${DOCKER_REGISTRY_NAMESPACE}"
                            echo "Image: ${IMAGE_NAME}:${IMAGE_TAG}"
                            echo "=========================================="

                            echo "\$DOCKER_PASSWORD" | docker login ${DOCKER_REGISTRY} -u "\$DOCKER_USERNAME" --password-stdin

                            echo ""
                            echo "Tagging for registry..."
                            docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${FULL_IMAGE_NAME}:${IMAGE_TAG}
                            docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${FULL_IMAGE_NAME}:${params.ENVIRONMENT}

                            echo ""
                            echo "Pushing image..."
                            docker push ${FULL_IMAGE_NAME}:${IMAGE_TAG}
                            docker push ${FULL_IMAGE_NAME}:${params.ENVIRONMENT}

                            echo ""
                            echo "=========================================="
                            echo "✅ Image pushed to registry!"
                            echo "   ${FULL_IMAGE_NAME}:${IMAGE_TAG}"
                            echo "   ${FULL_IMAGE_NAME}:${params.ENVIRONMENT}"
                            echo "=========================================="
                        """
                    }
                }
            }
        }

        stage('Pull Docker Image from Registry') {
            when {
                expression { params.ENVIRONMENT == 'prod' }
            }
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: "${DOCKER_REGISTRY_CREDENTIALS}", usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                        sh """
                            echo "=========================================="
                            echo "Pulling image from registry for Production..."
                            echo "Registry: ${DOCKER_REGISTRY}"
                            echo "Image: ${FULL_IMAGE_NAME}:${IMAGE_TAG}"
                            echo "=========================================="

                            echo "\$DOCKER_PASSWORD" | docker login ${DOCKER_REGISTRY} -u "\$DOCKER_USERNAME" --password-stdin

                            echo ""
                            echo "Pulling image..."
                            docker pull ${FULL_IMAGE_NAME}:${IMAGE_TAG}

                            echo ""
                            echo "Tagging as prod and local name..."
                            docker tag ${FULL_IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:${IMAGE_TAG}
                            docker tag ${FULL_IMAGE_NAME}:${IMAGE_TAG} ${FULL_IMAGE_NAME}:prod

                            echo ""
                            echo "Pushing prod tag to registry..."
                            docker push ${FULL_IMAGE_NAME}:prod

                            echo ""
                            echo "=========================================="
                            echo "✅ Production image ready!"
                            echo "   Local: ${IMAGE_NAME}:${IMAGE_TAG}"
                            echo "   Registry: ${FULL_IMAGE_NAME}:prod"
                            echo "=========================================="
                        """
                    }
                }
            }
        }

        stage('Deploy to Swarm (Rolling Update)') {
            when {
                expression { !params.SKIP_DEPLOY }
            }
            steps {
                script {
                    def stackName = params.ENVIRONMENT == 'prod' ? STACK_NAME_PROD :
                                   params.ENVIRONMENT == 'staging' ? STACK_NAME_STAGING : STACK_NAME_DEV
                    def composeFile = params.ENVIRONMENT == 'prod' ? 'docker-compose-swarm-prod.yml' :
                                     params.ENVIRONMENT == 'staging' ? 'docker-compose-swarm-staging.yml' :
                                     'docker-compose-swarm.yml'

                    dir("${WORK_DIR}") {
                        sh """
                            export IMAGE_TAG=${IMAGE_TAG}
                            docker stack deploy -c ${composeFile} ${stackName} --with-registry-auth
                        """
                    }
                }
            }
        }

        stage('Verify Deployment') {
            when {
                expression { !params.SKIP_DEPLOY }
            }
            steps {
                script {
                    def stackName = params.ENVIRONMENT == 'prod' ? STACK_NAME_PROD :
                                   params.ENVIRONMENT == 'staging' ? STACK_NAME_STAGING : STACK_NAME_DEV

                    sh """
                        docker stack services ${stackName}
                        sleep 15
                        docker service ls | grep ${stackName}
                    """
                }
            }
        }
    }

    post {
        success {
            mail to: "${EMAIL_RECIPIENT}",
                 subject: "✅ Pipeline Success: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: """
Pipeline: ${env.JOB_NAME}
Build: #${env.BUILD_NUMBER}
Status: SUCCESS ✅

Environment: ${params.ENVIRONMENT}
Image: ${FULL_IMAGE_NAME}:${IMAGE_TAG}
Commit: ${GIT_COMMIT}

View build: ${env.BUILD_URL}
"""
        }
        failure {
            mail to: "${EMAIL_RECIPIENT}",
                 subject: "❌ Pipeline Failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: """
Pipeline: ${env.JOB_NAME}
Build: #${env.BUILD_NUMBER}
Status: FAILED ❌

Environment: ${params.ENVIRONMENT}
Commit: ${GIT_COMMIT}

Please check the build logs for details.

View build: ${env.BUILD_URL}
"""
        }
    }
}
